<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Elite Voting Portal</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Syncopate:wght@700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root {
  --gold: #d4af37;
  --gold-glow: rgba(212, 175, 55, 0.3);
  --glass: rgba(255, 255, 255, 0.03);
  --bg: #050505;
}

body {
  background: radial-gradient(circle at top right, #1a1a1a, #050505);
  color: #e0e0e0;
  font-family: 'Inter', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

.gala-font {
  font-family: 'Cinzel', serif;
  letter-spacing: 2px;
  color: var(--gold);
}

.title-font {
  font-family: 'Syncopate', sans-serif;
  letter-spacing: 6px;
  text-transform: uppercase;
  background: linear-gradient(to bottom, #fff 0%, var(--gold) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* AUTH OVERLAY */
#authOverlay {
  position: fixed;
  inset: 0;
  background: black;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  transition: transform 1.2s cubic-bezier(0.8, 0, 0.2, 1);
}

.auth-card {
  background: linear-gradient(145deg, rgba(20,20,20,0.9), rgba(5,5,5,0.9));
  border: 1px solid rgba(212, 175, 55, 0.2);
  padding: 4rem 3rem;
  border-radius: 40px;
  max-width: 500px;
  width: 90%;
  text-align: center;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

.form-control-gala {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(212, 175, 55, 0.3);
  color: white !important;
  border-radius: 0;
  border-bottom: 2px solid var(--gold);
  padding: 15px;
  text-align: center;
}

.form-control-gala:focus {
  background: rgba(255, 255, 255, 0.12); /* Slightly lighter background on focus */
  box-shadow: 0 0 20px var(--gold-glow);
  border-color: var(--gold);
  color: #ffffff !important; /* Forces text to white */
  outline: none;
  caret-color: var(--gold); /* Makes the blinking cursor gold */
}

/* VOTING UI */
.glass-card {
  background: var(--glass);
  backdrop-filter: blur(15px);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 24px;
  padding: 2rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.vote-item {
  cursor: pointer;
  padding: 1.2rem;
  border-radius: 12px;
  margin-bottom: 0.8rem;
  background: rgba(255,255,255,0.03);
  border: 1px solid transparent;
  transition: all 0.4s ease;
  animation: slideUp 0.5s ease backwards;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.vote-item:hover {
  background: rgba(212, 175, 55, 0.05);
  border-color: var(--gold-glow);
  transform: scale(1.02);
}

.vote-item.selected {
  background: linear-gradient(90deg, rgba(212, 175, 55, 0.15), transparent);
  border-left: 4px solid var(--gold);
  color: var(--gold);
}

.btn-gala {
  background: linear-gradient(135deg, #d4af37 0%, #f9e29c 50%, #d4af37 100%);
  color: #1a1a1a;
  font-weight: 800;
  padding: 18px;
  border-radius: 4px;
  border: none;
  text-transform: uppercase;
  letter-spacing: 2px;
  transition: 0.3s;
  box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
}

.btn-gala:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px var(--gold-glow);
}

.btn-gala:disabled {
  background: #333;
  color: #666;
}

.progress-track {
  height: 2px;
  background: rgba(255,255,255,0.1);
  width: 100%;
  margin: 20px 0;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: var(--gold);
  box-shadow: 0 0 10px var(--gold);
  transition: width 0.8s ease;
}

/* Fix for Chrome/Safari white background on autofill */
input:-webkit-autofill,
input:-webkit-autofill:hover, 
input:-webkit-autofill:focus {
  -webkit-text-fill-color: white !important;
  -webkit-box-shadow: 0 0 0px 1000px #1a1a1a inset;
  transition: background-color 5000s ease-in-out 0s;
}
</style>
</head>

<body>

<div id="authOverlay">
  <div class="auth-card">
    <h6 class="gala-font mb-1">ОФФИЦИАЛЬНОЕ ГОЛОСОВАНИЕ</h6>
    <h2 class="title-font mb-5">Ваше имя</h2>
    <input id="userName" class="form-control form-control-gala mb-4" placeholder="Полное Имя">
    <button id="loginBtn" class="btn-gala w-100">Зайти на церемонию</button>
  </div>
</div>

<div class="container py-5" id="mainContent" style="opacity:0; transition: opacity 1s;">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="text-center mb-5">
        <h6 class="gala-font mb-2">Выбор Категории</h6>
        <div class="progress-track">
            <div id="progressBar" class="progress-fill" style="width: 0%"></div>
        </div>
        <h1 id="voteTitle" class="title-font mt-4"></h1>
        <p id="selectionHint" class="text-muted mt-2" style="font-size: 0.8rem; color: #FFF !important;"></p>
      </div>

      <div id="optionsContainer" class="glass-card mb-4"></div>
      
      <div class="text-center">
        <button id="submitVote" class="btn-gala px-5" disabled>Выбрать Опции</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import { firebaseConfig } from "/ochkovote2025-2026/firebase-config.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* STATE */
let categories = [];
let currentIndex = 0;
let voteLimit = 1;
let selected = new Set();

/* LOAD DATA */
async function loadData() {
  const res = await fetch("data.json");
  const json = await res.json();
  categories = Object.entries(json);
  loadCategory();
}

/* LOAD CATEGORY */
function loadCategory() {
  selected.clear();
  const [key, options] = categories[currentIndex];

  const match = key.match(/\(q(\d+)/);
  voteLimit = match ? Number(match[1]) : 1;

  voteTitle.innerText = key.split("(")[0].trim();
  
  const progPercent = ((currentIndex + 1) / categories.length) * 100;
  progressBar.style.width = `${progPercent}%`;
  selectionHint.innerText = `Вы можете выбрать до ${voteLimit} номинации`;

  optionsContainer.innerHTML = "";
  submitVote.disabled = true;

  options.forEach((opt, index) => {
    const div = document.createElement("div");
    div.className = "vote-item";
    div.style.animationDelay = `${index * 0.1}s`;
    div.innerText = opt;

    div.onclick = () => {
      if (selected.has(opt)) {
        selected.delete(opt);
        div.classList.remove("selected");
      } else if (selected.size < voteLimit) {
        selected.add(opt);
        div.classList.add('selected');
      } else if (voteLimit === 1) {
        selected.clear();
        document.querySelectorAll('.vote-item').forEach(i => i.classList.remove('selected'));
        selected.add(opt);
        div.classList.add('selected');
      }
      submitVote.disabled = selected.size === 0;
    };
    optionsContainer.appendChild(div);
  });
}

/* LOGIN */
loginBtn.onclick = async () => {
  const name = userName.value.trim();
  if (name.length < 2) return alert("Введите имя");

  // Sanitize name for database path (remove dots, spaces, etc)
  const safeName = name.replace(/[.#$[\]\s]/g, "_");
  localStorage.setItem("name", name);
  localStorage.setItem("safeName", safeName);

  await signInAnonymously(auth);

  authOverlay.style.transform = "translateY(-100%)";
  mainContent.style.opacity = 1;

  loadData();
};

/* SUBMIT VOTE */
submitVote.onclick = async () => {
  const [rawKey] = categories[currentIndex];
  // Sanitize the category name for the path
  const safeKey = rawKey.split("(")[0].trim().replace(/[.#$[\]\s]/g, "_");
  const voterID = localStorage.getItem("safeName");

  submitVote.disabled = true;
  submitVote.innerText = "Регистрируем Голос...";

  try {
    // UPDATED: Now saves to votes/Name_Surname/Category_Name
    await set(
      ref(db, `votes/${voterID}/${safeKey}`),
      {
        voterDisplay: localStorage.getItem("name"),
        selections: Array.from(selected),
        timestamp: Date.now()
      }
    );

    currentIndex++;
    if (currentIndex < categories.length) {
      submitVote.innerText = "Подтвердить Голос";
      loadCategory();
    } else {
      triggerFinale();
    }
  } catch (err) {
    alert("ААА ОШИБКА 4012341213.");
    submitVote.disabled = false;
  }
};

/* THE FINALE */
function triggerFinale() {
  // Gold & White Confetti
  const duration = 5 * 1000;
  const end = Date.now() + duration;

  (function frame() {
    confetti({
      particleCount: 3,
      angle: 60,
      spread: 55,
      origin: { x: 0 },
      colors: ['#d4af37', '#ffffff']
    });
    confetti({
      particleCount: 3,
      angle: 120,
      spread: 55,
      origin: { x: 1 },
      colors: ['#d4af37', '#ffffff']
    });

    if (Date.now() < end) {
      requestAnimationFrame(frame);
    }
  }());

  optionsContainer.innerHTML = `
    <div class="text-center py-5">
        <h2 class="gala-font" style="color: #d4af37">Thank You</h2>
        <p>Ваш официальный выбор 2025 года подтвержден.</p>
        <button onclick="location.reload()" class="btn-gala mt-3" style="font-size: 0.8rem">Вернуться к входу</button>
    </div>`;
  submitVote.style.display = "none";
}
</script>

</body>
</html>
